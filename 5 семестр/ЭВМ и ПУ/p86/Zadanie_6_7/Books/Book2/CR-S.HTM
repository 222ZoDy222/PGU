<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0039)http://avsdov.newmail.ru/modes/cr-s.htm -->
<HTML><HEAD><TITLE>Соловьев А. Режимы работы процессоров семейста Intel x86. Приложение 1.</TITLE>
<META http-equiv=Content-Type content="text/html; charset=windows-1251">
<META content="Alexei V. Soloviev" name=Author>
<META content="MSHTML 6.00.2800.1106" name=GENERATOR>
<META http-equiv=Keywords 
content="защищенный режим, реальный режим, виртуальный режим, режим системного управления, SMM, V86, PM, RM, Соловьев"></HEAD>
<BODY text=#000000 vLink=#004080 aLink=#008000 link=#000080 bgColor=#cccccc 
background=cr-s.files/paper.gif>
<H5 align=center>Режимы работы процессоров семейста Intel x86. Приложение 1.</H5>
<a href="modes.htm"><IMG alt="К началу реферата" 
src="images/to_top.gif" align=right border=0 width="34" height="46"></a> 
<H4>СТРУКТУРА УПРАВЛЯЮЩИХ РЕГИСТРОВ ПРОЦЕССОРА</H4>
<CENTER>
  <IMG alt="Схема регистров CR0-CR4" src="images/cr-s.gif">
</CENTER><A 
name=CR0></A>
<P><B>Регистр CR0</B> - содержит флаги, управляющие режимом работы процессора и 
отражающие сосояние системы.
<UL>
  <LI><I>бит 0 (Protect Enable, 286+):</I> разрешение защиты. Когда PE=1 процессор 
    находится в защищенном режиме. Если бит сброшен, то процессор находится либо 
    в режиме реального адреса, либо в режиме системного управления (тип режима 
    определяется аппаратно: в режиме системного управления активен сигнал <I>SMIACT#</I>). 
    Подробнее см. <A 
  href="modes.htm#switch">"Переключение между режимами"</A>. 
  <LI><I>бит 1 (Math Present, 286+):</I> сопроцессор присутсвует. 
  <LI><I>бит 2 (Emulation, 286+):</I> эмуляция сопроцессора. Когда EM=1, любая 
  команда для сопроцессора или команда MMX вызывает особый случай. 
  <LI><I>бит 3 (Task Switched, 286+):</I> задача переключена. Каждый раз при переключении 
    задачи процессор выставляет этот бит. Используется для учета контекста сопроцессора 
    при переключении. Подробнее см. <A 
  href="modes.htm#multitask">"Мультизадачность"</A>. 
  <LI><I>бит 4 (Extension Type, 386,486):</I> тип расширения (сопроцессора). 
  Когда ET=1, для сопроцессора используется набор инструкций Intel 387DX. В 
  Pentium и P6 этот бит зарезервирован и всегда содержит 1. 
  <LI><I>бит 5 (Numeric Error, 486+):</I> численная ошибка (ошибка 
  сопроцессора). Когда NE=1, процессору разрешается пользоваться внутренним 
  ("родным") механизмом сигнализации ошибок с плавающей точкой. Когда NE=0, 
  процессор эмулирует сигнализацию ошибок с плавающей точкой как у внешних 
  сопроцессоров (287, 387). 
  <LI><I>бит 16 (Write Protect, 486+):</I> защита от записи страниц пользователя 
    с пометкой "read-only" при обращениях с уровня супервизора. Подробнее см. 
    <A 
  href="modes.htm#pageprot">"Защита на уровне страниц"</A>. 
  <LI><I>бит 18 (Alignment Mask, 486+):</I> маска выравниванивания. Если 
  CR0.AM=1 и EFLAGS.AC=1 и CR0.PE=1 и CPL=3, то производится контроль 
  выравнивания. Т.е. при обращениях к памяти двойное слово обязательно должно 
  начинаться с адреса, кратного 4, а слово - с адреса, кратного 2, иначе 
  генерируется нарушение контроля выравнивания (исключение #17). 
  <LI><I>бит 29 (Not Write-through, 486+):</I> несквозная запись - используется 
  для управления кэшированием. 
  <LI><I>бит 30 (Cache Disable, 486+):</I> запрещение кэш-памяти. 
  <LI><I>бит 31 (Paging, 386+):</I> разрешение страничного преобразования. Подробнее 
    см. <A 
  href="modes.htm#paging">"Страничное преобразование адресов"</A>. </LI>
</UL>
<P></P>
<P><B>Регистр CR1</B> - зарезервирован.</P>
<P><B>Регистр CR2</B> - содержит линейный адрес, вызвавший страничное нарушение 
(исключение #14).</P><A name=CR3></A>
<P><B>Регистр CR3</B> - содержит в битах 12-31 старшие 20 бит 32-битного физического 
  адреса каталога таблиц. Когда включено <I>расширение физического адреса</I>, 
  регистр CR3 содержит в битах 5-31 старшие 27 бит 36-битного физического адреса 
  таблицы указателей на каталоги таблиц страниц. Подробнее см. <A href="modes.htm#paging">"Страничное 
  преобразование адресов"</A>. Специальное назначение имеют биты 3 и 4, управляющие 
  кэшированием страницы, на которой находится каталог таблиц: 
<LI><I>бит 3 (Page Write-Through, 486+):</I> сквозная запись страницы. 
<LI><I>бит 4 (Page-Cache Disable, 486+):</I> запрещение кэширования 
страницы. 
<P></P><A name=CR4></A>
<P><B>Регистр CR4</B> - содержит флаги, контролирующие новые возможности 
(расширения) архитектуры Pentium и P6. Какими возможностями обладает процессор, 
можно узнать по результатам выполения команды <B>CPUID</B>.
<UL>
  <LI><I>бит 0 (Virtual-8086 Mode Extensions).</I> Разрешает <I>расширения 
  обработки прерываний и особых случаев в состоянии VM86</I>. VME позволяют 
  задаче в состоянии VM86 самостоятельно обрабатывать прерывания и особые 
  случаи, не переключаясь в нормальный режим. VME обеспечивают аппаратную 
  поддержку виртуального флага прерываний (VIF). 
  <LI><I>бит 1 (Protected Mode Virtual Interrupts).</I> Разрешает аппаратную 
  поддержку VIF. 
  <LI><I>бит 2 (Time Stamp Disable).</I> Когда TSD=1, выполнение инструкции 
  <B>RDTSC</B> (чтение внутреннего счетчика времени) ограничивается нулевым 
  уровнем привилегий, иначе инструкция разрешена на всех уровнях. 
  <LI><I>бит 3 (Debugging Extensions):</I> расширения отладки. DE позволяют 
  использовать регистры DR4 и DR5 для установки контрольных точек по портам 
  ввода-вывода. 
    <LI><I>бит 4 (Page Size Extension):</I> расширение размера страницы. Подробнее 
      см. <A href="modes.htm#paging">"Страничное преобразование адресов"</A>. 
    <LI><I>бит 5 (Physical Address Extension):</I> расширение физического адреса. 
    <LI><I>бит 6 (Machine Check Enable).</I> Разрешает особый случай машинного 
  контроля (исключение #18), возникающий, когда блок внутреннего контроля 
  операций внутри чипа или на шине обнаруживает ошибку. 
    <LI><I>бит 7 (Page Global Enable).</I> Разрешает использование бита глобальности 
      в <A 
  href="modes.htm#PDE_PTE">элементах PDE/PTE</A>. Это расширение позволяет часто 
      используемые или разделяемые (shared) страницы пометить как "глобальные". 
      Глобальные страницы не выгружаются из TLB при переключении задачи. 
    <LI><I>бит 8 (Performance-monitoring Counter Enable).</I> Когда PCE=1, 
  выполнение инструкции <B>RDPMC</B> (чтение внутреннего счетчика 
  производительности) разрешено на всех уровнях привилегий, иначе инструкция 
  будет выполняться только на нулевом уровне привилегий. </LI></UL><A 
name=EFLAGS></A>
<CENTER>
    <IMG alt="Схема регистра EFLAGS" 
src="images/eflags.gif">
</CENTER>&nbsp;&nbsp;&nbsp; Биты CF (флаг переноса), 
PF (флаг четности), AF (флаг вспомогательного переноса), ZF (флаг нуля), SF 
(флаг знака), OF (флаг переполнения) отражают результат целочисленных операций. 
Они появились еще в процессоре 8086. Здесь они не рассматриваются. 
<UL>
  <LI><I>бит 8 (Trap Flag):</I> флаг ловушки. Когда TF=1, процессор после 
  выполнения каждой инструкции генерирует особый случай отладки (исключение #1). 
  Используется дебуггерами для пошагового исполнения отлаживаемой программы. 
  <LI><I>бит 9 (Interrupt Flag):</I> флаг прерываний. Когда IF=0, прерывания по 
  входу IRQ (маскируемые) игнорируются, иначе после подтвержения прерывания и 
  получения его вектора вызывается соответствующий обработчик. 
  <LI><I>бит 10 (Direction Flag):</I> флаг направления. Управляет работой 
  цепочечных команд. Когда DF=0, при выполнении цепочечной команды происходит 
  автоинкремент адресов источника/получателя. Когда DF=1 - автодекремент. 
    <LI><I>биты 12,13 (I/O Privilege Level, 286+):</I> уровень привилегий операций 
      ввода-вывода. Подробнее см. <A 
  href="modes.htm#SegmProt">"Защита на уровне сегментов".</A> 
    <LI><I>бит 14 (Nested Task, 286+):</I> вложенная задача. Если при переключении 
      задачи происходит вложение задач, то этот флаг устанавливается в 1. Совместно 
      с полем <A title="См. формат TSS на примере из MS Windows 95" 
  href="gdt-idt.htm">Link TSS в сегменте состояния задачи</A> этот флаг обеспечивает 
      корректное вложение задач. 
    <LI><I>бит 16 (Resume Flag, 386+):</I> флаг возобновления. Когда RF=1, 
  временно запрещаются особые случаи отладки для контрольных точек (другие 
  события все равно смогут вызвать исключение #1). 
    <LI><I>бит 17 (Virtual-8086 Mode, 386+):</I> виртуальный режим. Переводит задачу 
      в состояние эмуляции 8086. Подробнее см. <A 
  href="modes.htm#multitask">"Мультизадачность"</A>. 
    <LI><I>бит 18 (Alignment Check, 486+).</I> Разрешает контроль выравнивания для 
  текущей задачи. Контроль выравнивания производится, если CR0.AM=1 и 
  EFLAGS.AC=1 и CR0.PE=1 и CPL=3, Т.е. при обращениях к памяти двойное слово 
  обязательно должно начинаться с адреса, кратного 4, а слово - с адреса, 
  кратного 2, иначе генерируется нарушение контроля выравнивания (исключение 
  #17). 
  <LI><I>бит 19 (Virtual Interrupt Flag, Pentium+):</I> виртуальный флаг 
  прерываний. Используется совместно с флагом VIP. Процессор распознает VIF, 
  если разрешены VME или PVI=1 и IOPL&lt;3. 
  <LI><I>бит 20 (Virtual Interrupt Pending, Pentium+):</I> отложить виртуальное 
  прерывание. Программа устанавливает этот флаг, если хочет, чтобы обработка 
  прерываний была отложена. Используется совместно с VIF. Процессор читает этот 
  флаг, но никогда не изменяет его. Флаг распознается, если разрешены VME или 
  PVI=1 и IOPL&lt;3. 
  <LI><I>бит 21 (Identification, Pentium+).</I> Если программа может изменить 
  этот флаг (т.е. процессор хранит то значение, которое программа запишет в этот 
  флаг), то процессор поддерживает инструкцию <B>CPUID</B>. Инструкцию 
  <B>CPUID</B> поддерживают не только Pentium и P6, но и некоторые улучшенные 
  модели 486х. </LI></UL>
  <A href="modes.htm"><IMG 
alt="К началу реферата" src="images/to_top.gif" align=right border=0 width="34" height="46"></A> 
  <BR>
  &nbsp;<BR><FONT size=1><I>Последние изменения 
21.03.1999.</I><BR></FONT><BR></LI></BODY></HTML>
