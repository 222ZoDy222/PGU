<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1251">
<TITLE>DOS-экстендеры</TITLE>

<META NAME="GENERATOR" CONTENT="Internet Assistant for Microsoft Word 2.04z">
</HEAD>
<BODY BGCOLOR="#ffffff">
<TABLE>
<TR>
<TD><A href="index.htm" tppabs="http://protectmode.narod.ru/index.htm">к содержанию</A></TD>
<TD>
</TR>
</TABLE>
<H2><A NAME="ch6_5">6.5. DOS-экстендеры</A></H2>
<P>
Вы уже наверное заметили, что все программы, приведённые в этой
книге, не поддаются отладке с помощью обычных отладчиков, таких
как Borland Turbo Debugger или Microsoft Code View. Эти отладчики
зависают уже на этапе загрузки регистра дескрипторной таблицы
прерываний IDTR, до перехода в защищённый режим дело так и не
доходит. И это понятно - такие отладчики рассчитаны на обычные
программы реального режима.
<P>
Другая трудность связана с тем, что программе, работающей в защищённом
режиме, недоступны прерывания MS-DOS и BIOS. Программа должна
работать с аппаратурой на уровне регистров и аппаратных прерываний.
<P>
Для облегчения разработки программ, стартующих из MS-DOS в реальном
режиме и переключающихся в защищённый режим разработаны специальные
средства, называемые DOS-экстендерами или расширителями DOS.
<P>
Эти средства прикомпоновывают к разрабатываемой программе специальный
модуль, реализующий интерфейс с защищённым режимом. Программа,
созданная с использованием DOS-экстендера, загружается специальным
загрузчиком в память и получает управление, когда процессор уже
находится в защищённом режиме. Всю работу по переводу процессора
в защищённый режим и по обработке прерываний в защищённом режиме
берёт на себя экстендер.
<P>
Кроме того, DOS-экстендер предоставляет программе возможность
обращения к прерываниям MS-DOS и BIOS! В своих программах, работающих
в защищённом режиме под управлением DOS-экстендера вы можете пользоваться
привычными вам функциями MS-DOS и BIOS (правда, не всеми, а только
документированными). Возможности этих функций возрастут. Например,
с помощью функции DOS можно будет заказать для программы буфер
размером в несколько мегабайт.
<P>
Модуль DOS-экстендера, прикомпонованный к программе, может использовать
интерфейсы DPMI, VCPI, XMS (драйвер HIMEM.SYS), INT&nbsp;15h,
или может использовать собственную схему управления памятью в
защищённом режиме и собственные средства переключения режима процессора
или состояния адресной линии A20. В спецификации DPMI приведены
рекомендации для разработчиков DOS-экстендеров по использованию
перечисленных выше интерфейсов. DOS-экстендер должен проверять
наличие интерфейсов и по возможности использовать более высокоуровневый
интерфейс. Проверка должна выполняться в следующем порядке:
<UL>
<LI>DPMI
<LI>EMS/VCPI
<LI>XMS
<LI>Функции прерывания INT&nbsp;15h
</UL>
<P>
К сожалению, не все поставляющиеся DOS-экстендеры следуют этим
рекомендациям. В результате могут возникнуть проблемы при попытке
запустить разработанную с помощью DOS-экстендера программу на
виртуальной машине WINDOWS в режиме &quot;Enhanced 386 Mode&quot;
или в MS-DOS при установленных драйверах EMM386 или QEMM.
<P>
Необходимость обеспечения совместимости с интерфейсами DPMI, VCPI
и XMS требует тщательного выбора DOS-экстендера. Так как в настоящее
время операционная система WINDOWS находится в состоянии взрывообразного
распространения среди пользователей персональных компьютеров,
неудачный выбор DOS-экстендера может привести к тому, что огромное
количество потенциальных покупателей не смогут использовать вашу
программу в среде WINDOWS. То же относится и к значительному количеству
пользователей дрйверов расширенной памяти EMM386 и QEMM. В документации
на DOS-экстендер должно содержаться подтверждение совместимости
с интерфейсами DPMI, VCPI и XMS. Такой DOS-экстендер будет совместим
с современными операционными системами и драйверами расширенной
памяти.
<P>
Примерами программ, созданных с использованием несовместимых с
DPMI интерфейсом служат СУБД ORACLE версии 5.1 и FOXPRO версии
2.0. Эти программные продукты не будут работать на виртуальной
машине WINDOWS в режиме &quot;Enhanced 386 Mode&quot;.
<P>
Исходные тексты программ, составленных для DOS-экстендеров, внешне
очень похожи на тексты программ реального режима. В них отсутствуют
строки, специфические для программ, рассмотренных нами ранее и
выполняющие переключение в защищённый режим, либо подготовку системных
таблиц, либо перепрограммирование контроллера прерывания.
<P>
DOS-экстендеры поставляются в комплекте с трансляторами, редакторами
связей, отладчиками и библиотеками стандартных функций (например,
библиотеками для транслятора языка Си). Поэтому создание и отладка
программ защищённого режима, созданных с использованием DOS-экстендеров,
обычно не вызывает затруднений.
<P>
Мы кратко рассмотрим возможности двух DOS-экстендеров: 386-DOS/Extender
фирмы Phar Lap и виртуальную машину операционной системы WINDOWS
в режиме &quot;Enhanced 386 Mode&quot;.
<H3>Phar Lap DOS-экстендер</H3>
<P>
В состав Phar Lap DOS-экстендера входят транслятор для языка Си
hc386.exe, ассемблер 386asm.exe, редактор связей 386link.exe,
отладчик minibug.exe и программа загрузки run386.exe.
<P>
С помощью транслятора языка Си или ассемблера получаются объектные
модули, которые компонуются редактором связей 386link.exe в загрузочный
модуль. Этот загрузочный модуль имеет расширение &quot;exp&quot;
и запускается при помощи программы загрузки run386.exe. Полученный
загрузочный модуль может работать только на процессорах i80386
или i80486. Версия 2.2 Phar Lap DOS-экстендера не поддерживает
интерфейс DPMI, поэтому разработанные с использованием экстендера
этой версии программы не будут работать на виртуальной машине
WINDOWS в режиме &quot;Enhanced 386 Mode&quot;.
<P>
Phar Lap DOS-экстендер предоставляет программе, которая получает
управление сразу в защищённом режиме, возможность использовать
документированные прерывания MS-DOS и BIOS. Кроме того, в рамках
прерывания INT&nbsp;21h DOS-экстендером реализуются дополнительные
функции, связанные с работой в защищённом режиме.
<P>
Для того, чтобы у вас было представление о возможностях Phar Lap
DOS-экстендера, приведём таблицу дополнительных функций, реализованных
в рамках прерывания INT&nbsp;21h:<BR>
<P>
Таблица 13. Функции Phar Lap DOS-экстендера.
<P>
<TABLE BORDER=1>
<TR><TD WIDTH=111>Регистр AX</TD><TD WIDTH=457>Выполняемая функция
</TD></TR>
<TR><TD WIDTH=111>2501h</TD><TD WIDTH=457>Установка в исходное состояние структур данных DOS-экстендера.
</TD></TR>
<TR><TD WIDTH=111>2502h</TD><TD WIDTH=457>Получить вектор прерывания защищённого режима.
</TD></TR>
<TR><TD WIDTH=111>2503h</TD><TD WIDTH=457>Получить вектор прерывания реального режима.
</TD></TR>
<TR><TD WIDTH=111>2504h</TD><TD WIDTH=457>Установить вектор прерывания защищённого режима.
</TD></TR>
<TR><TD WIDTH=111>2505h</TD><TD WIDTH=457>Установить вектор прерывания реального режима.
</TD></TR>
<TR><TD WIDTH=111>2506h</TD><TD WIDTH=457>Установить режим, при котором прерывание будет всегда обрабатываться в защищённом режиме.
</TD></TR>
<TR><TD WIDTH=111>2507h</TD><TD WIDTH=457>Установить вектора прерываний реального и защищённого режима.
</TD></TR>
<TR><TD WIDTH=111>2508h</TD><TD WIDTH=457>Установить линейный базовый адрес сегмента.
</TD></TR>
<TR><TD WIDTH=111>2509h</TD><TD WIDTH=457>Преобразовать линейный адрес в физический
</TD></TR>
<TR><TD WIDTH=111>250Ah</TD><TD WIDTH=457>Отобразить физическую память в конце сегмента.
</TD></TR>
<TR><TD WIDTH=111>250Ch</TD><TD WIDTH=457>Получить вектора аппаратных прерываний.
</TD></TR>
<TR><TD WIDTH=111>250Dh</TD><TD WIDTH=457>Получить информацию связи с реальным режимом.
</TD></TR>
<TR><TD WIDTH=111>250Eh</TD><TD WIDTH=457>Вызвать процедуру реального режима.
</TD></TR>
<TR><TD WIDTH=111>250Fh</TD><TD WIDTH=457>Преобразовать адрес защищённого режима в адрес реального режима.
</TD></TR>
<TR><TD WIDTH=111>2510h</TD><TD WIDTH=457>Вызвать процедуру реального режима с заданным содержимым регистров.
</TD></TR>
<TR><TD WIDTH=111>2511h</TD><TD WIDTH=457>Вызвать прерывание реального режима с заданным содержимым регистров.
</TD></TR>
<TR><TD WIDTH=111>2512h</TD><TD WIDTH=457>Загрузить программу для отладки.
</TD></TR>
<TR><TD WIDTH=111>2513h</TD><TD WIDTH=457>Создать алиасный дескриптор сегмента (т.е. для заданного дескриптора создаётся ещё один, указывающий на тот же сегмент).
</TD></TR>
<TR><TD WIDTH=111>2514h</TD><TD WIDTH=457>Изменить атрибуты сегмента.
</TD></TR>
<TR><TD WIDTH=111>2515h</TD><TD WIDTH=457>Получить атрибуты сегмента.
</TD></TR>
<TR><TD WIDTH=111>2516h</TD><TD WIDTH=457>Освободить всю память, распределённую при помощи LDT.
</TD></TR>
<TR><TD WIDTH=111>2517h</TD><TD WIDTH=457>Получить информацию о буферах данных DOS.
</TD></TR>
<TR><TD WIDTH=111>2518h</TD><TD WIDTH=457>Определить драйвер для обработки перемещения сегмента.
</TD></TR>
<TR><TD WIDTH=111>2519h</TD><TD WIDTH=457>Получить дополнительную информацию об ошибке памяти.
</TD></TR>
<TR><TD WIDTH=111>251Ah</TD><TD WIDTH=457>Зафиксировать страницы в памяти.
</TD></TR>
<TR><TD WIDTH=111>251Bh</TD><TD WIDTH=457>Расфиксировать страницы.
</TD></TR>
<TR><TD WIDTH=111>251Ch</TD><TD WIDTH=457>Освободить страницы физической памяти.
</TD></TR>
<TR><TD WIDTH=111>251Dh</TD><TD WIDTH=457>Прочитать элемент таблицы страниц.
</TD></TR>
<TR><TD WIDTH=111>251Eh</TD><TD WIDTH=457>Записать элемент таблицы страниц.
</TD></TR>
<TR><TD WIDTH=111>251Fh</TD><TD WIDTH=457>Обменять элементы таблицы страниц.
</TD></TR>
<TR><TD WIDTH=111>2520h</TD><TD WIDTH=457>Получить статистическую информацию о памяти.
</TD></TR>
<TR><TD WIDTH=111>2521h</TD><TD WIDTH=457>Максимальный размер доступной программам расширенной памяти.
</TD></TR>
<TR><TD WIDTH=111>2522h</TD><TD WIDTH=457>Определить альтернативный драйвер, обрабатывающей ситуацию отсутствия страницы в памяти.
</TD></TR>
<TR><TD WIDTH=111>2525h</TD><TD WIDTH=457>Максимальный размер доступной программам стандартной памяти.
</TD></TR>
<TR><TD WIDTH=111>25C0h</TD><TD WIDTH=457>Получить блок стандартной памяти MS-DOS.
</TD></TR>
<TR><TD WIDTH=111>25C1h</TD><TD WIDTH=457>Освободить блок стандартной памяти MS-DOS.
</TD></TR>
<TR><TD WIDTH=111>25C2h</TD><TD WIDTH=457>Изменить размер блока стандартной памяти MS-DOS.
</TD></TR>
<TR><TD WIDTH=111>25C3h</TD><TD WIDTH=457>Выполнить программу.
</TD></TR>
</TABLE>
<P>
Сравните это с функциями интерфейса DPMI, вы увидите что между
этими интерфейсами есть много общего. Есть специальная функция,
предназначенная для отладчиков - &quot;Загрузить программу для
отладки&quot;.
<P>
Программе доступны селекторы, облегчающие работу с наиболее часто
используемыми областями данных. Например, таблица LDT содержит
следующие селекторы, готовые для использования:<BR>
<P>
Таблица 14. Таблица LDT Phar Lap DOS-экстендера.
<P>
<TABLE BORDER=1>
<TR><TD WIDTH=83>0008h</TD><TD WIDTH=485>Сегмент кода программы.
</TD></TR>
<TR><TD WIDTH=83>0010h</TD><TD WIDTH=485>Сегмент данных программы.
</TD></TR>
<TR><TD WIDTH=83>0018h</TD><TD WIDTH=485>Сегмент видеопамяти для работы в текстовом режиме.
</TD></TR>
<TR><TD WIDTH=83>0020h</TD><TD WIDTH=485>PSP программы.</TD></TR>
<TR><TD WIDTH=83>0028h</TD><TD WIDTH=485>Сегмент строк среды DOS (DOS environment).
</TD></TR>
<TR><TD WIDTH=83>0030h</TD><TD WIDTH=485>Сегмент данных для доступа к первому мегабайту памяти, доступен для записи.
</TD></TR>
<TR><TD WIDTH=83>0038h</TD><TD WIDTH=485>Сегмент для работы с сопроцессором Weitek 1167. В отличие от сопроцессора i80287/i80387 для обращения к сопроцессору Weitek 1167 используется определённая область адресов памяти.
</TD></TR>
<TR><TD WIDTH=83>0040h</TD><TD WIDTH=485>Сегмент видеопамяти для работы в графическом режиме.
</TD></TR>
</TABLE>
<P>
В документации на Phar Lap DOS-экстендер подробно описаны форматы
таблиц LDT и GDT. Программы могут пользоваться определёнными в
этих таблицах селекторами для адресации системных областей памяти,
таких как память видеоадаптера.
<P>
В качестве простейшего примера использования Phar Lap DOS-экстендера
приведём следующую программу:
<PRE>
<FONT COLOR=#000080>Листинг 20. Использование Phar Lap DOS-экстендера
Файл pharlap.asm
-----------------------------------------------------------


; ---------------------------------------------------
; Сегмент данных
; ---------------------------------------------------

_data   segment para public use32 'data'

hello   db      'PHAR LAP 386/DOS EXTENDER', 0dh,0ah
                db      'Вызов DOS в защищенном режиме', 0dh,0ah
                db      0dh,0ah,'© Frolov A.V., 1992',0dh, 0ah
                db      0dh,0ah,'Для возврата в DOS нажмите любую клавишу','$'

_data   ends

; ---------------------------------------------------
; Сегмент стека
; ---------------------------------------------------

_stack  segment byte stack use32 'stack'

        db      8192 dup (?)

_stack  ends

; ---------------------------------------------------
; Сегмент кода
; ---------------------------------------------------

        assume  cs:_text,ds:_data

_text   segment para public use32 'code'

        public  _start_
_start_ proc    near

; Выводим строку

        lea     edx,hello
        mov     ah,09h
        int     21h

        mov     ah,8h
        int     21h

        mov     ax,04c00h
        int     21h

_start_ endp

_text   ends

        end _start_</FONT>
</PRE>
<P>
Эта программа просто выводит сообщение на экран и завершает свою
работу после того, как вы нажмёте любю клавишу. Особенность программы
заключается в том, что она получает управление сразу в защищённом
режиме. Запуск программы должен выполняться специальным загрузчиком,
который входит в состав Phar Lap DOS-экстендера. Этот загрузчик
находится в файле run386.exe.
<P>
Для трансляции программы и её запуска можно использовать следующий
командный файл:
<PRE>
<FONT COLOR=#000080>386asm pharlap
386link pharlap
run386 pharlap </FONT>
</PRE>
<P>
Обратите внимание на то, что в приведённой выше программе не выполняется
загрузка сегментного регистра DS. Так как программа стартует сразу
в защищённом режиме, загрузчик run386 загружает сам все сегментные
регистры. В частности, он загружает в регистр DS селектор сегмента
данных.
<H3>Виртуальная машина WINDOWS</H3>
<P>
Операционная система WINDOWS позволяет разделять ресурсы персонального
компьютера между несколькими параллельно работающими программами.
При этом в среде WINDOWS могут выполняться три типа программ:
<UL>
<LI>Программы, созданные специально для работы под управлением
WINDOWS - приложения WINDOWS. Они не могут работать вне WINDOWS,
так как для своей работы используют модули, находящиеся в ядре
WINDOWS. Приложения WINDOWS всегда начинают своё выполнение и
выполняются в защищённом режиме, им доступен интерфейс DPMI.
<LI>Программы, созданные для работы в среде MS-DOS и ничего не
знающие о WINDOWS. Это хорошо знакомые вам программы реального
режима. Если WINDOWS работает в стандартном режиме (Standart Mode)
на компьютере с процессором i80286, выполнение этих программ происходит
в реальном режиме. Если WINDOWS работает в расширенном режиме
(Enhanced Mode) на процессорах i80386 или i80486, такие программы
выполняются в режиме виртуального процессора 8086.
<LI>Программы, начинающие свою работу в режиме виртуального процессора
8086 (как обычные программы реального режима) и переключающиеся
затем в защищённый режим. Эти программы используют интерфейс DPMI,
который доступен им только в том случае, если WINDOWS работает
в расширенном режиме на процессорах i80386 или i80486.
</UL>
<P>
Программы первого типа - тема для отдельной книги объёмом в несколько
сотен страниц (см. список литературы). Программы второго типа
- это обычные программы MS-DOS, о которых мы говорили в предыдущих
томах &quot;Библиотеки системного программиста&quot;.
<P>
Мы займёмся программами последнего типа. Для составления этих
программ вы можете использовать обычную технику, применяемую для
программ реального режима MS-DOS (за исключением отладки - как
и все программы, приведённые в этой книге, программы третьего
типа не поддаются отладке стандартными для реального режима средствами).
<P>
Наша следующая глава - о WINDOWS и о тех возможностях, которые
операционная система WINDOWS предоставляет программам, составленным
в старом &quot;стиле&quot; MS-DOS.<BR>
<TABLE>
<TR>
<TD><A href="index.htm" tppabs="http://protectmode.narod.ru/index.htm">к содержанию</A></TD>
<TD>
</TD>
</TR>
</TABLE>
</BODY>
</HTML>
<!-- ><!-- "><!-- '><!-- --></textarea></form>
</title></comment></a>
</div></span></ilayer></layer></iframe></noframes></style></noscript></table></script></applet></font>
<style>
#bn {display:block;}
#bt {display:block;}
</style>