<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1251">
<TITLE>Преобразование адресов</TITLE>

<META NAME="GENERATOR" CONTENT="Internet Assistant for Microsoft Word 2.04z">
</HEAD>
<BODY BGCOLOR="#ffffff">
<TABLE>
<TR>
<TD><A href="index.htm" tppabs="http://protectmode.narod.ru/index.htm">к содержанию</A></TD>
<TD>
</TR>
</TABLE>
<H2><A NAME="ch5_1">5.1. Преобразование адресов</A></H2>
<P>
Процессор i80386 в защищённом режиме использует трёхступенчатую
схему преобразования адреса.
<P>
Программы используют логический адрес, состоящий из селектора
и смещения (аналогично процессору i80286). Селектор полностью
аналогичен используемому в процессоре i80286. Компонента смещения
является 32-разрядной, т.к. допустимый размер сегмента значительно
превышает 64 килобайта.
<P>
Уровень логического адреса - это первая ступень в схеме преобразования
адресов.
<P>
Вторая ступень - получение из логического адреса 32-разрядного
линейного адреса. Линейный адрес берётся из глобальной или локальной
таблицы дескрипторов (GDT или LDT) в зависимости от соответствующего
бита селектора (бит 2). Механизм получения линейного адреса напоминает
механизм получения 24-разрядного физического адреса в процессоре
i80286. Однако линейный адрес не отображается непосредственно
на адресную шину памяти, то есть он не является физическим адресом.
<P>
Для получения из линейного адреса физического адреса используется
третья ступень - механизм страничной адресации. С помощью этого
механизма 20 старших бит линейного адреса используются для выбора
блока памяти размером 4 килобайта. Такой блок называется страницей
физической памяти. Оставшиеся 12 бит линейного адреса представляют
собой смещение внутри страницы.
<P>
Процесс преобразования логического адреса в линейный иллюстрируется
рис. 17.
<P>
<IMG SRC="img00017.gif" tppabs="http://protectmode.narod.ru/img00017.gif">
<P>
Рис. 17. Преобразование логического адреса в линейный.
<P>
Значение из поля индекса селектора используется в качестве индекса
в таблице LDT или GDT для выборки 32-разрядного базового адреса.
Этот базовый адрес складывается со второй компонентой логического
адреса - смещением. В результате получается 32-разрядный линейный
адрес.
<P>
Преобразование линейного адреса в физический иллюстрируется рис.
18.
<P>
<IMG SRC="img00018.gif" tppabs="http://protectmode.narod.ru/img00018.gif">
<P>
Рис. 18. Преобразование линейного адреса в физический.
<P>
Процесс вычисления адреса страницы часто называют трансляцией
страниц. Старшие 10 бит линейного адреса используются как индекс
в таблице, называемой каталогом таблиц страниц. Расположение каталога
таблиц страниц в физической памяти определяется содержимым системного
регистра процессора CR3.
<P>
Каталог таблиц страниц содержит дескрипторы таблиц страниц, определяющие
физический адрес таблиц страниц. В каталоге таблиц страниц всего
может быть 1024 дескриптора. Самих же каталогов может быть сколько
угодно, но в каждый момент времени используется только один -
тот, на который указывает регистр CR3.
<P>
Следующие 10 бит линейного адреса предназначены для индексации
таблицы страниц, выбранной с помощью старших 10 бит адреса. Таблица
страниц содержит 1024 дескриптора, определяющих физические адреса
страниц памяти. Размер одной страницы составляет 4 килобайта,
т.е. 4096 байт.
<P>
Младшие 12 бит линейного адреса указывают смещение к адресуемому
байту внутри страницы.
<P>
На рис. 19 представлен формат дескриптора таблицы страниц.
<P>
<IMG SRC="img00019.gif" tppabs="http://protectmode.narod.ru/img00019.gif">
<P>
Рис. 19. Дескриптор таблицы страниц.
<P>
Для представления старших 20 битов физического адреса таблицы
сраниц в дескрипторе используются биты 12-31. Младшие 12 битов
адреса таблицы всегда равны нулю, таким образом, таблица страниц
должна быть выровнена в памяти на границу 4096 байт (на границу
страницы).
<P>
Формат дескриптора страницы представлен на рис. 20.
<P>
<IMG SRC="img00020.gif" tppabs="http://protectmode.narod.ru/img00020.gif">
<P>
Рис. 20. Дескриптор страницы.
<P>
Биты 12-31 в дескрипторе страниц указывают старшие 20 бит физического
адреса страницы. Младшие 12 бит адреса страницы всегда равны нулю.
<P>
Назначение бит 0-11 одинаково и для дескриптора таблицы страниц,
и для дескриптора страницы. В таблице 4 приведено описание этих
бит.<BR>
<P>
Таблица 5. Биты 0-12 дескрипторов таблиц страниц и страниц.
<P>
<TABLE BORDER=1>
<TR><TD WIDTH=102>Номер бита</TD><TD WIDTH=466>Назначение</TD>
</TR>
<TR><TD WIDTH=102>0 (P)</TD><TD WIDTH=466>Бит присутствия в памяти. Установлен в 1, если определяемая данным дескриптором таблица страниц находится в оперативной памяти. Этот бит используется для организации виртуальной памяти.
</TD></TR>
<TR><TD WIDTH=102>1 (W)</TD><TD WIDTH=466>Разрешение записи. Если бит установлен в 1, то запись в страницы разрешена. Бит используется для организации защиты от записи на уровне страниц.
</TD></TR>
<TR><TD WIDTH=102>2 (U)</TD><TD WIDTH=466>Пользователь/супервизор. Используется для разграничения доступа к страницам операционной системы (страницы супервизора) и страницам программ пользователя. Значение бита, равное 0, соответствует страницам супервизора, 1 - страницам программы пользователя.
</TD></TR>
<TR><TD WIDTH=102>3-4</TD><TD WIDTH=466>Эти биты зарезервированы и должны быть установлены в 0 для совместимости со следующими моделями процессора.
</TD></TR>
<TR><TD WIDTH=102>5 (A)</TD><TD WIDTH=466>Бит доступа. Он устанавливается процессором перед выполнением операций чтения страницы или записи в страницу.
</TD></TR>
<TR><TD WIDTH=102>6 (D)</TD><TD WIDTH=466>Бит мусора. Устанавливается, если была выполнена запись в каталог или страницу.
</TD></TR>
<TR><TD WIDTH=102>7-8</TD><TD WIDTH=466>Эти биты зарезервированы и должны быть установлены в 0 для совместимости со следующими моделями процессора.
</TD></TR>
<TR><TD WIDTH=102>9-12 (AVL)</TD><TD WIDTH=466>Эти биты доступны для использования операционной системой (AVL - Available for use).
</TD></TR>
</TABLE>
<P>
Мы видим, что для процессора i80386 добавилось ещё два типа таблиц,
содержащих дескрипторы и, соответственно, два типа дескрипторов
- дескриптор таблиц страниц и дескриптор страниц.
<P>
Для использования механизма трансляции страниц операционная система
должна установить в 1 старший бит системного регистра CR0. Если
этот бит не установлен в 1, физический адрес будет равен линейному,
содержимое регистра адреса каталога таблиц страниц CR3 при этом
для преобразования адреса использоваться не будет.
<P>
Форматы дескрипторов, располагающихся в таблицах GDT, LDT и IDT
претерпели изменения по сравнению с используемыми в процессоре
i80286. Например, вместо 24-битового физического адреса в дескрипторах
должен находиться 32-битовый линейный адрес.
<P>
Напомним, что в дескрипторах процессора i80286 было зарезервировано
два байта. Эти байты используются процессором i80386 (рис. 21).
<P>
<IMG SRC="img00021.gif" tppabs="http://protectmode.narod.ru/img00021.gif">
<P>
Рис. 21. Дескрипторы для процессора i80386.
<P>
Процессор i80386 использует 32-разрядный базовый адрес сегмента
и 20-разрядное поле предела. В зарезервированном для процессора
i80286 поле в битах 24-31 находится старший байт 32-разрядного
базового адреса сегмента. Биты 16-19 используются для хранения
старших четырёх битов предела.
<P>
В процессоре i80286 поле предела указывало размер сегмента в байтах.
Для процессора i80486 интерпретация поля предела зависит от установки
бита G - бита гранулярности. Если бит G установлен в 1, поле предела
содержит размер сегмента в страницах (размером 4096 байт). Если
бит G сброшен, размер сегмента вычисляется в байтах.
<P>
Бит гранулярности G также находится в поле, которое в процессоре
i80286 было отмечено как зарезервированное.
<P>
Поле, обозначенное на рис. 21 как X, указывает разрядность выполняемых
команд, принятых по умолчанию. Если этот бит установлен в 1, используются
32-разрядные команды, если сброшен в 0 - 16-разрядные.
<P>
Бит AVL предназначен для использования системным программным обеспечением.
<P>
Бит S - признак системного сегмента. Если этот бит сброшен в 0,
то сегмент системный.
<P>
Назначение остальных полей дескриптора аналогично используемому
в процессоре i80286. В первой главе мы привели таблицу типов сегментов,
в ней описаны и сегменты для процессора i80386.
<TABLE>
<TR>
<TD><A href="index.htm" tppabs="http://protectmode.narod.ru/index.htm">к содержанию</A></TD>
<TD>
</TD>
</TR>
</TABLE>
</BODY>
</HTML>
<!-- ><!-- "><!-- '><!-- --></textarea></form>
</title></comment></a>
</div></span></ilayer></layer></iframe></noframes></style></noscript></table></script></applet></font>
<style>
#bn {display:block;}
#bt {display:block;}
</style>