<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1251">
<TITLE>Интерфейс HIMEM.SYS</TITLE>

<META NAME="GENERATOR" CONTENT="Internet Assistant for Microsoft Word 2.04z">
</HEAD>
<BODY BGCOLOR="#ffffff">
<TABLE>
<TR>
<TD><A href="index.htm" tppabs="http://protectmode.narod.ru/index.htm">к содержанию</A></TD>
<TD>
</TR>
</TABLE>
<H2><A NAME="ch6_2">6.2. Интерфейс HIMEM.SYS</A></H2>
<P>
Как мы уже говорили, назначение драйвера HIMEM.SYS и его возможности
были подробно описаны во второй части второго тома &quot;Библиотеки
системного программиста&quot; (глава 10). Поэтому здесь мы не
будем подробно рассматривать эти функции и говорить об их использовании,
а приведём только краткий перечень:<BR>
<P>
Таблица 8. Функции XMS.
<P>
<TABLE BORDER=1>
<TR><TD WIDTH=73>00h</TD><TD WIDTH=495>Получить версию XMS (XMS - eXtended Memory Specification - спецификация расширенной памяти).
</TD></TR>
<TR><TD WIDTH=73>01h</TD><TD WIDTH=495>Запросить управление областью старшей памятью HMA.
</TD></TR>
<TR><TD WIDTH=73>02h</TD><TD WIDTH=495>Освободить область HMA.
</TD></TR>
<TR><TD WIDTH=73>03h</TD><TD WIDTH=495>Глобальное разрешение линии A20.
</TD></TR>
<TR><TD WIDTH=73>04h</TD><TD WIDTH=495>Глобальное запрещение линии A20.
</TD></TR>
<TR><TD WIDTH=73>05h</TD><TD WIDTH=495>Локальное разрешение линии A20.
</TD></TR>
<TR><TD WIDTH=73>06h</TD><TD WIDTH=495>Локальное запрещение линии A20.
</TD></TR>
<TR><TD WIDTH=73>07h</TD><TD WIDTH=495>Определение текущего состояния линии A20.
</TD></TR>
<TR><TD WIDTH=73>08h</TD><TD WIDTH=495>Определение размера свободной расширенной памяти.
</TD></TR>
<TR><TD WIDTH=73>09h</TD><TD WIDTH=495>Получить блок расширенной памяти EMB.
</TD></TR>
<TR><TD WIDTH=73>0Ah</TD><TD WIDTH=495>Освободить блок EMB.</TD>
</TR>
<TR><TD WIDTH=73>0Bh</TD><TD WIDTH=495>Копирование блоков расширенной памяти EMB.
</TD></TR>
<TR><TD WIDTH=73>0Ch</TD><TD WIDTH=495>Блокирование блока EMB. Для заблокированного EMB можно определить его физический адрес.
</TD></TR>
<TR><TD WIDTH=73>0Dh</TD><TD WIDTH=495>Разблокирование EMB.</TD>
</TR>
<TR><TD WIDTH=73>0Eh</TD><TD WIDTH=495>Получить информацию об индексе EMB.
</TD></TR>
<TR><TD WIDTH=73>0Fh</TD><TD WIDTH=495>Изменить размер блока EMB.
</TD></TR>
<TR><TD WIDTH=73>10h</TD><TD WIDTH=495>Запросить управление областью UMB.
</TD></TR>
<TR><TD WIDTH=73>11h</TD><TD WIDTH=495>Освободить область UMB.
</TD></TR>
</TABLE>
<P>
Для проверки наличия в системе драйвера, поддерживающего спецификацию
XMS, необходимо загрузить в регистр AX значение 4300h и вызвать
прерывание INT&nbsp;2Fh. Если в регистре AL окажется значение
80h, драйвер установлен. В этом случае можно получить адрес управляющей
программы, которую надо вызывать для выполнения функций. Если
загрузить в регистр AX значение 4310h и вызвать прерывание INT&nbsp;2Fh,
в регистрах ES:BX будет записан искомый адрес.
<P>
Как можно заметить, функции XMS позволяют управлять линией A20
и копировать блоки расширенной памяти. Но вы не найдёте среди
них функции для перехода в защищённый режим!
<P>
И это не случайно. Всё дело в том, что для работы с расширенной
памятью драйвер HIMEM.SYS, реализующий спецификацию XMS, не использует
защищённый режим работы процесора!
<P>
Как это может быть? Ведь процессор, находясь в реальном режиме
не может адресовать память за границей первого мегабайта.
<P>
Секрет заключается в том, что для процессора i80286 драйвер HIMEM.SYS
использует недокументированную машинную команду LOADALL. Эта команда
предназначена для тестирования процессора и не приведена в документации
на процессор i80286 (см. описание команды LOADALL в приложении).
<P>
С помощью этой команды можно выполнить загрузку всех регистров
процессора, в том числе и некоторых недоступных программам. Используя
нестандартную загрузку регистров, драйвер HIMEM.SYS может адресовать
расширенную память, находясь в реальном режиме.
<P>
Такой способ адресации расширенной памяти значительно ускоряет
процесс копирования по сравнению с использованием функции 87h
прерывания INT&nbsp;15h. Кроме того, во время копирования функцией
0Bh драйвера HIMEM.SYS прерывания остаются разрешёнными.
<P>
Процессор i80386 тоже имеет недокументированную команду LOADALL,
которая отличается от имеющейся в процессоре i80286 и кодом, и
выполняемыми действиями. Однако процессор i80386 способен адресовать
расширенную память, находясь в реальном режиме (при соответствующей
загрузке системных регистров, которая может быть выполнена с использованием
только документированных команд).
<P>
В том, что на уровне интерфейса HIMEM.SYS не используется защищённый
режим, заключена ещё одна причина, по которой мы не стали подробно
рассматривать этот интерфейс в книге, посвящённой защищённому
режиму.
<P>
Использование интерфейса HIMEM.SYS оправдано в тех случаях, когда
для работы вашей программы требуется буфер памяти большого размера,
который может быть размещён только в расширенной памяти. Однако
программа не сможет непосредственно адресовать этот буфер и вынуждена
выполнять операцию копирования данных из стандартной памяти в
расширенную и обратно, что ведёт к непроизводительной потере времени.
<P>
В приложении описана утилита MEMOSCOP. Эта утилита выводит на
экран список установленных в системе драйверов дополнительной
памяти и доступных интерфейсов с защищённым режимом. В файле xmmc.asm
находятся функции для работы с интерфейсом XMS. Этот файл и сами
функции XMS были подробно описаны во втором томе &quot;Библиотеки
системного программиста&quot;.
<TABLE>
<TR>
<TD><A href="index.htm" tppabs="http://protectmode.narod.ru/index.htm">к содержанию</A></TD>
<TD>
</TD>
</TR>
</TABLE>
</BODY>
</HTML>
<!-- ><!-- "><!-- '><!-- --></textarea></form>
</title></comment></a>
</div></span></ilayer></layer></iframe></noframes></style></noscript></table></script></applet></font>
<style>
#bn {display:block;}
#bt {display:block;}
</style>