<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1251">
<TITLE>Возврат в реальный режим</TITLE>

<META NAME="GENERATOR" CONTENT="Internet Assistant for Microsoft Word 2.04z">
</HEAD>
<BODY BGCOLOR="#ffffff">
<TABLE>
<TR>
<TD><A href="index.htm" tppabs="http://protectmode.narod.ru/index.htm">к содержанию</A></TD>
<TD>
</TR>
</TABLE>
<H2><A NAME="ch2_3">2.3. Возврат в реальный режим</A></H2>
<P>
Для того, чтобы вернуть процессор 80286 из защищённого режима
в реальный, необходимо выполнить аппаратный сброс (отключение)
процессора. Это можно сделать следующим образом:
<PRE>
<FONT COLOR=#000080>mov     ax, 0FEh        ; команда отключения
out     64h, ax


</FONT>
</PRE>
<P>
Перед выдачей команды отключения необходимо запомнить содержимое
регистра SP, так как после передачи управления по адресу, записанному
в области данных BIOS 0040h:0067h, регистры SS:SP будет указывать
на стек BIOS.
<P>
После выдачи команды отключения надо подождать, когда произойдёт
сброс процессора. Это можно сделать, выдавая в цикле команду HLT.
<P>
Вот фрагмент программы, возвращающий процессор в реальный режим:
<PRE>
<FONT COLOR=#000080>; Запоминаем содержимое указателя стека, так как после
; сброса процессора оно будет потеряно

        mov     [real_sp],sp

; Выполняем сброс процессора

        mov     al,SHUT_DOWN
        out     STATUS_PORT,al

; Ожидаем сброса процессора

wait_reset:
        hlt
        jmp     wait_reset


</FONT>
</PRE>
<P>
Далее необходимо восстановить содержимое сегментных регистров,
записанное в оперативную память на этапе подготовки к переключению
в защищённый режим, закрыть адресную линию A20 и размаскировать
прерывания.
<P>
Для закрытия линии A20 можно воспользоваться следующей процедурой:
<PRE>
<FONT COLOR=#000080>; ------------------------------------------------------------
; Процедура закрывает адресную линию A20
; ------------------------------------------------------------

PROC    disable_a20     NEAR
        mov     al,A20_PORT
        out     STATUS_PORT,al
        mov     al,A20_OFF
        out     KBD_PORT_A,al
        ret
ENDP    disable_a20


</FONT>
</PRE>
<P>
Следующая последовательность команд размаскирует все прерывания:
<PRE>
<FONT COLOR=#000080>        mov     ax,000dh        ; разрешаем немаскируемые прерывания
        out     CMOS_PORT,al

        in      al,INT_MASK_PORT ; разрешаем маскируемые прерывания
        and     al,0
        out     INT_MASK_PORT,al
        sti


</FONT>
</PRE>
<P>
Теперь, когда мы знаем всё, что нужно для переключения процессора
в защищённый режим и возврата в реальный режим, можно приступить
к практической работе в защищённом режиме.
<TABLE>
<TR>
<TD><A href="index.htm" tppabs="http://protectmode.narod.ru/index.htm">к содержанию</A></TD>
<TD>
</TD>
</TR>
</TABLE>
</BODY>
</HTML>
<!-- ><!-- "><!-- '><!-- --></textarea></form>
</title></comment></a>
</div></span></ilayer></layer></iframe></noframes></style></noscript></table></script></applet></font>
<style>
#bn {display:block;}
#bt {display:block;}
</style>