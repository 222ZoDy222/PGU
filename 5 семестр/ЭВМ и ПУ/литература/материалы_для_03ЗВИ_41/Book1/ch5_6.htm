<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1251">
<TITLE>Переключение в защищённый и реальный режимы</TITLE>

<META NAME="GENERATOR" CONTENT="Internet Assistant for Microsoft Word 2.04z">
</HEAD>
<BODY BGCOLOR="#ffffff">
<TABLE>
<TR>
<TD><A href="index.htm" tppabs="http://protectmode.narod.ru/index.htm">к содержанию</A></TD>
<TD>
</TR>
</TABLE>
<H2><A NAME="ch5_6">5.6. Переключение в защищённый и реальный
режимы</A></H2>
<P>
Процессоры i80386 и i80486 могут легко переключаться из реального
режима в защищённый и обратно с помощью команды MOV. Младший бит
PE системного регистра CR0 (см. приложение) определяет текущий
режим работы процессора. Если этот бит установлен в 1, процессор
работает в защищённом режиме, а если в 0 - в реальном.
<P>
Для переключения процессора из реального режима в защищённый можно
использовать, например, такую последовательность команд:
<PRE>
<FONT COLOR=#000080>mov     ax,     cr0
or      ax,     1
mov     cr0,    ax</FONT>
</PRE>
<P>
Для совместимости с процессором i80286 оставлена возможность переключения
в защищённый режим с помощью команды LMSW.
<P>
Для возврата в реальный режим необходимо сбросить бит PE:
<PRE>
<FONT COLOR=#000080>mov     ax,     cr0
and     ax,     0fffe
mov     cr0,    ax</FONT>
</PRE>
<P>
Таким образом, существует более красивый способ возврата в реальный
режим, чем выполнение аппаратного сброса или перевод процессора
в состояние отключения (конечно, вы по-прежнему можете пользоваться
старым способом перевода процессора в реальный режим).
<P>
Перед переключением в реальный режим из защищённого программа
должна выполнить следующие действия:
<UL>
<LI>обеспечить равенство линейных адресов физическим;
<LI>отключить трансляцию страниц, сбросив бит PG в регистре CR0;
<LI>загрузить ноль в регистр CR3 для сброса кэш-памяти страниц;
<LI>передать управление сегменту кода с пределом 64 килобайта;
<LI>загрузить в сегментные регистры SS, DS, ES, FS, GS селекторы
дескрипторов, подготовленных для адресации памяти в реальном режиме
и содержащих соответствующие реальному режиму значения;
<LI>запретить маскируемые и немаскируемые прерывания;
<LI>сбросить бит PE, переключив процессор в реальный режим;
<LI>выполнить команду дальнего перехода для очистки внутренней
очереди команд процессора;
<LI>настроить систему прерываний для работы в реальном режиме;
<LI>разрешить прерывания;
<LI>загрузить в сегментные регистры значения, необходимые для
работы в реальном режиме.
</UL>
<P>
Как видите, процедура возврата в реальный режим сильно упростилась
и ускорилась по сравнению с использованной для процессора i80286.
Однако большинство программ, переключившись в защищённый режим,
никогда больше не возвращаются назад. Они либо всё время работают
в защищённом режиме, либо переключаются в режим виртуального процессора
8086.
<TABLE>
<TR>
<TD><A href="index.htm" tppabs="http://protectmode.narod.ru/index.htm">к содержанию</A></TD>
<TD>
</TD>
</TR>
</TABLE>
</BODY>
</HTML>
<!-- ><!-- "><!-- '><!-- --></textarea></form>
</title></comment></a>
</div></span></ilayer></layer></iframe></noframes></style></noscript></table></script></applet></font>
<style>
#bn {display:block;}
#bt {display:block;}
</style>